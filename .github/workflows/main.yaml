# Workflow name displayed in GitHub Actions UI
name: Build and Publish

# Trigger: Run this workflow on every push to any branch or when tags are pushed
on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    tags:
      - 'v*'

jobs:
  build:
    # Use the latest Ubuntu runner provided by GitHub
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
    # Step 1: Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Setup Go programming environment
    # - Installs Go version 1.23.3
    # - Enables dependency caching using go.sum file location
    - name: Setup Go environment
      uses: actions/setup-go@v6.2.0
      with:
        go-version: '1.23.3'
        cache-dependency-path: my-dazl-project/go.sum

    # Step 3: Build and prepare artifacts using Makefile
    # - Compiles the Go application
    # - Creates publish_output directory
    # - Copies binary and configuration files
    # - Displays artifact contents
    - name: Build and prepare artifacts
      run: make all

    # Step 4: Upload build artifacts to GitHub
    # - Artifacts can be downloaded from the Actions run page
    # - Artifacts are stored for 90 days by default
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: my-dazl-project
        path: publish_output

    # Step 5: Create GitHub Release and upload artifacts (only for tags)
    # - Creates a new release when a version tag (v*) is pushed
    # - Uploads all files from publish_output to the release
    # - Makes the release available for download
    - name: Create Release and Upload Assets
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: publish_output/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 6: Build and push Docker image to GitHub Container Registry
  # - Uses the reusable docker.yaml workflow
  # - Downloads artifacts and builds Docker image
  # - Only runs when a version tag (v*) is pushed
  docker:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/docker.yaml
    with:
      image_name: ghcr.io/${{ github.repository_owner }}/my-dazl-project
      dockerfile_path: ./Dockerfile
      context_path: .
      artifact_name: my-dazl-project
      artifact_path: publish_output
    secrets:
      gh_token: ${{ secrets.GITHUB_TOKEN }}

  # Step 7: Clean up temporary build directory
  # - Removes publish_output directory
  # - Removes compiled binary from project folder
  # - Waits for docker job to complete (if it runs)
  cleanup:
    needs: [build, docker]
    if: always() && needs.build.result != 'skipped'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cleanup artifacts directory
      run: make clean
