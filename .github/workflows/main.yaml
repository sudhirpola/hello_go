# Workflow name displayed in GitHub Actions UI
name: Build and Publish

# Trigger: Run this workflow on every push to any branch or when tags are pushed
on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'

jobs:
  build:
    # Use the latest Ubuntu runner provided by GitHub
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
    # Step 1: Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Setup Go programming environment
    # - Installs Go version 1.23.3
    # - Enables dependency caching using go.sum file location
    - name: Setup Go environment
      uses: actions/setup-go@v6.2.0
      with:
        go-version: '1.23.3'
        cache-dependency-path: my-dazl-project/go.sum

    # Step 3: Build and prepare artifacts using Makefile
    # - Compiles the Go application
    # - Creates publish_output directory
    # - Copies binary and configuration files
    # - Displays artifact contents
    - name: Build and prepare artifacts
      run: make all

    # Step 4: Upload build artifacts to GitHub
    # - Artifacts can be downloaded from the Actions run page
    # - Artifacts are stored for 90 days by default
    - name: Upload artifacts
      uses: actions/upload-artifact@v6.0.0
      with:
        name: my-dazl-project
        path: publish_output

    # Step 5: Create GitHub Release and upload artifacts (only for tags)
    # - Creates a new release when a version tag (v*) is pushed
    # - Uploads all files from publish_output to the release
    # - Makes the release available for download
    - name: Create Release and Upload Assets
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: publish_output/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Step 6: Build and push Docker image to GitHub Container Registry
    # - Logs in to ghcr.io
    # - Creates a Docker image with the Go binary
    # - Pushes image tagged with commit SHA and latest
    # - Only runs when a version tag (v*) is pushed
    - name: Log in to GitHub Container Registry
      if: startsWith(github.ref, 'refs/tags/v')
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/my-dazl-project
        IMAGE_TAG=${{ github.sha }}
        VERSION_TAG=${{ github.ref_name }}

        # Create Dockerfile if it doesn't exist
        if [ ! -f Dockerfile ]; then
          cat > Dockerfile << 'DOCKERFILE'
        FROM alpine:latest
        RUN apk --no-cache add ca-certificates
        WORKDIR /app
        COPY publish_output/my-dazl-project /app/
        COPY publish_output/logging.yaml /app/
        CMD ["/app/my-dazl-project"]
        DOCKERFILE
        fi

        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -t ${IMAGE_NAME}:${VERSION_TAG} -t ${IMAGE_NAME}:latest .
        docker push ${IMAGE_NAME}:${IMAGE_TAG}
        docker push ${IMAGE_NAME}:${VERSION_TAG}
        docker push ${IMAGE_NAME}:latest

    # Step 7: Clean up temporary build directory
    # - Removes publish_output directory
    # - Removes compiled binary from project folder
    - name: Cleanup artifacts directory
      run: make clean
